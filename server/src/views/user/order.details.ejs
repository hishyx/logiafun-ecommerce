<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details - LogiaFun</title>
  <link rel="stylesheet" href="/css/home.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0f172a;
      --accent: #3b82f6;
      --surface: #ffffff;
      --background: #f8fafc;
      --text-main: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --success: #22c55e;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      background-color: var(--background);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
    }

    .order-details-container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .order-id-section h1 {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .order-date {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .order-status-badge {
      padding: 0.5rem 1.25rem;
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }


    /* Pending */
    .status-pending {
      background: #fef9c3;
      color: #ca8a04;
    }

    /* Processing */
    .status-processing {
      background: #fff7ed;
      color: #d97706;
    }

    /* Shipped / In transit */
    .status-in_transit,
    .status-shipped {
      background: #eff6ff;
      color: #2563eb;
    }

    /* Delivered */
    .status-delivered {
      background: #ecfdf5;
      color: #059669;
    }

    /* Cancelled */
    .status-cancelled {
      background: #fef2f2;
      color: #dc2626;
    }

    /* Returned */
    .status-returned {
      background: #f5f3ff;
      color: #7c3aed;
    }

    .order-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      margin-bottom: 2rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .item-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .order-item {
      display: flex;
      gap: 1.25rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .order-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .item-image {
      width: 90px;
      height: 90px;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: #f1f5f9;
      flex-shrink: 0;
      border: 1px solid var(--border);
    }

    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .item-info {
      flex-grow: 1;
    }

    .item-category {
      font-size: 0.75rem;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .item-name {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: block;
      text-decoration: none;
    }

    .item-meta {
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .summary-row.total {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      color: var(--primary);
      font-weight: 700;
      font-size: 1.1rem;
    }

    .address-info p {
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .address-name {
      font-weight: 600;
      color: var(--primary) !important;
    }

    /* Cancellation UI Styles */
    .btn-cancel {
      padding: 0.6rem 1.25rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      border: 1px solid #ef4444;
      background: transparent;
      color: #ef4444;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: fit-content;
      margin-top: 0.5rem;
    }

    .btn-cancel:hover {
      background: #fef2f2;
      transform: translateY(-1px);
    }

    .btn-cancel-order {
      width: 100%;
      justify-content: center;
      margin-top: 1.5rem;
    }

    /* VERY SIMPLE CANCELLATION POPUP STYLES */
    .cancel-box {
      display: none;
      /* Hidden by default */
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      background-color: white;
      border: 2px solid #000;
      padding: 20px;
      z-index: 1000;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
    }

    .cancel-box h2 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    .cancel-box textarea {
      width: 100%;
      height: 100px;
      margin-top: 10px;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
    }

    .cancel-btn-group {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .popup-btn {
      padding: 8px 16px;
      cursor: pointer;
    }

    .btn-confirm {
      background-color: red;
      color: white;
      border: none;
    }

    .btn-close {
      background-color: #eee;
      border: 1px solid #ccc;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @media (max-width: 850px) {
      .order-grid {
        grid-template-columns: 1fr;
      }
    }

    .download-invoice-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.25rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: fit-content;
      text-decoration: none;
    }

    .download-invoice-btn:hover {
      background: #1e293b;
      transform: translateY(-1px);
    }
  </style>
</head>

<body>
  <%- include('../partials/header.ejs') %>

    <main class="order-details-container">
      <!-- Breadcrumbs -->
      <div class="breadcrumbs" style="margin-bottom: 2rem; font-size: 0.9rem; color: var(--text-secondary);">
        <a href="/home" style="color: inherit; text-decoration: none;"><i class="fa-solid fa-house"></i></a>
        <i class="fa-solid fa-chevron-right" style="margin: 0 0.5rem; font-size: 0.7rem;"></i>
        <a href="/user/orders" style="color: inherit; text-decoration: none;">My Orders</a>
        <i class="fa-solid fa-chevron-right" style="margin: 0 0.5rem; font-size: 0.7rem;"></i>
        <span style="color: var(--primary); font-weight: 500;">Order Details</span>
      </div>

      <div class="order-header">
        <div class="order-id-section">
          <h1>Order #<%= order.orderNumber %>
          </h1>
          <div class="order-date">Placed on <%= new Date(order.createdAt).toLocaleDateString('en-IN', { day: 'numeric' ,
              month: 'long' , year: 'numeric' }) %>
          </div>
        </div>
        <% const currentStatus=order.orderStatus %>
          <div class="order-status-badge status-<%= currentStatus %>">
            <i class="fa-solid <%= 
          currentStatus === 'cancelled' ? 'fa-circle-xmark' : 
          currentStatus === 'delivered' ? 'fa-circle-check' : 'fa-circle-dot' 
        %>"></i>
            <%= currentStatus %>
          </div>

          <!-- Added Download Invoice Button UI -->
          <button class="download-invoice-btn" id="download-invoice-btn" onclick="downloadInvoice('<%=order._id%>')">
            <i class="fa-solid fa-file-pdf"></i>
            Download Invoice
          </button>

          <% if ((currentStatus==='cancelled' || currentStatus==='returned' ) && order.statusChangeReason) { %>
            <div
              style="margin-top: 0.5rem; font-size: 0.9rem; color: <%= currentStatus === 'cancelled' ? '#dc2626' : '#7c3aed' %>; font-weight: 500;">
              <strong>
                <%= currentStatus==='cancelled' ? 'Cancellation' : 'Return' %> Reason:
              </strong>
              <%= order.statusChangeReason %>
            </div>
            <% } %>
      </div>

      <div class="order-grid">
        <div class="order-main">
          <!-- Items Card -->
          <div class="card">
            <div class="card-title">
              <i class="fa-solid fa-box-open" style="color: var(--accent);"></i>
              Order Items
            </div>
            <div class="item-list">
              <% order.items.forEach(item=> { %>
                <div class="order-item">
                  <div class="item-image">
                    <img src="<%= item.product.image %>" alt="<%= item.product.name %>">
                  </div>
                  <div class="item-info">
                    <h3 class="item-name">
                      <%= item.product.name %>
                    </h3>
                    <div class="item-meta">
                      <span>Quantity: <%= item.quantity %></span>
                      <div style="text-align: right;">
                        <% if (item.product.discountPercent> 0) { %>
                          <div
                            style="font-size: 0.75rem; color: var(--text-secondary); text-decoration: line-through; margin-bottom: 2px;">
                            ₹<%= item.product.originalPrice %>
                          </div>
                          <div style="font-size: 0.75rem; color: var(--success); font-weight: 600; margin-bottom: 2px;">
                            <%= item.product.discountPercent %>% OFF
                          </div>
                          <% } %>
                            <span style="font-weight: 600; color: var(--primary);">₹<%= item.product.price %></span>
                      </div>
                    </div>
                    <div class="order-status-badge status-<%= item.status %>"
                      style="width: fit-content; margin-top: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.75rem;">
                      <i class="fa-solid <%= 
                    item.status === 'cancelled' ? 'fa-circle-xmark' : 
                    item.status === 'delivered' ? 'fa-circle-check' : 'fa-circle-dot' 
                  %>"></i>
                      <%= item.status.charAt(0).toUpperCase() + item.status.slice(1) %>
                    </div>
                    <% if ((item.status==='cancelled' || item.status==='returned' ) && item.statusChangeReason) { %>
                      <div
                        style="margin-top: 0.25rem; font-size: 0.75rem; color: <%= item.status === 'cancelled' ? '#dc2626' : '#7c3aed' %>; font-weight: 500;">
                        <strong>
                          <%= item.status==='cancelled' ? 'Cancellation' : 'Return' %> Reason:
                        </strong>
                        <%= item.statusChangeReason %>
                      </div>
                      <% } %>
                        <% if (transitions[item.status]) { %>
                          <% if (transitions[item.status].includes("cancelled")) { %>
                            <button class="btn-cancel"
                              onclick="openCancelItem('<%= item._id %>', '<%= item.product.name %>')">
                              <i class="fa-solid fa-xmark"></i> Cancel Item
                            </button>
                            <% } else if (transitions[item.status].includes("returned")) { %>
                              <button class="btn-cancel" style="border-color: #7c3aed; color: #7c3aed;"
                                onclick="openReturnItem('<%= item._id %>', '<%= item.product.name %>')">
                                <i class="fa-solid fa-rotate-left"></i> Return Item
                              </button>
                              <% } %>
                                <% } %>
                  </div>
                </div>
                <% }) %>
            </div>
          </div>

          <!-- Shipping Address Card -->
          <div class="card">
            <div class="card-title">
              <i class="fa-solid fa-location-dot" style="color: var(--accent);"></i>
              Shipping Address
            </div>
            <div class="address-info">
              <p class="address-name">
                <%=order.address.name %>
              </p>
              <p>
                <%=order.address.street %>
              </p>
              <p>
                <%= order.address.city %> - <%= order.address.pincode %>
              </p>
              <p><i class="fa-solid fa-phone" style="width: 20px;"></i>
                <%=order.address.phone %>
              </p>
            </div>
          </div>
        </div>

        <div class="order-sidebar">
          <!-- Payment Summary Card -->
          <div class="card">
            <div class="card-title">
              <i class="fa-solid fa-receipt" style="color: var(--accent);"></i>
              Payment Summary
            </div>
            <div class="payment-summary">

              <div class="summary-row">
                <span>Shipping</span>
                <span style="color: var(--success); font-weight: 500;">Free</span>
              </div>

              <div class="summary-row total">
                <span>Order Total</span>
                <span>₹<%= order.totalAmount %></span>
              </div>

            </div>
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
              <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                Payment Method</div>
              <div style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem;">
                <i class="fa-solid fa-credit-card"></i>
                <%= order.payment.method %>
              </div>
            </div>

            <% const canCancelEntireOrder=order.items.every(item=>
              item.status === "cancelled" || (transitions[item.status] &&
              transitions[item.status].includes("cancelled"))
              );
              const canReturnEntireOrder = order.orderStatus === "delivered" && order.items.every(item =>
              item.status === "delivered" || (transitions[item.status] && transitions[item.status].includes("returned"))
              );
              %>

              <% if (canCancelEntireOrder && currentStatus !=='cancelled' && currentStatus !=='delivered' &&
                currentStatus !=='returned' ) { %>
                <button class="btn-cancel btn-cancel-order" onclick="openCancelOrder()">
                  <i class="fa-solid fa-ban"></i> Cancel Entire Order
                </button>
                <% } else if (canReturnEntireOrder && currentStatus==='delivered' ) { %>
                  <button class="btn-cancel btn-cancel-order" style="border-color: #7c3aed; color: #7c3aed;"
                    onclick="openReturnOrder()">
                    <i class="fa-solid fa-rotate-left"></i> Return Entire Order
                  </button>
                  <% } %>
          </div>
        </div>
      </div>
    </main>

    <!-- Simple Cancellation/Return Popup -->
    <div id="cancelPopup" class="cancel-box">
      <h2 id="cancelTitle">Cancel Order</h2>
      <p id="cancelDesc">Please enter your cancellation reason:</p>

      <textarea id="cancelReasonText" placeholder="Write reason here..."></textarea>

      <div class="cancel-btn-group">
        <!-- Button to close the popup without doing anything -->
        <button class="popup-btn btn-close" onclick="closeCancelBox()">Keep Order</button>

        <!-- Button to proceed with cancellation -->
        <button class="popup-btn btn-confirm" id="confirmButton" onclick="confirmAction()">Confirm</button>
      </div>
    </div>

    <%- include('../partials/footer.ejs') %>

      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script>
        // Variables to store what we are doing
        let currentId = "";
        let actionType = ""; // 'cancel' or 'return'
        let targetType = ""; // 'order' or 'item'

        // Function to open popup for ENTIRE ORDER CANCELLATION
        function openCancelOrder() {
          actionType = "cancel";
          targetType = "order";
          currentId = "<%= order._id %>";
          document.getElementById("cancelTitle").innerText = "Cancel Entire Order";
          document.getElementById("cancelDesc").innerText = "Please enter your cancellation reason:";
          document.getElementById("confirmButton").innerText = "Confirm Cancel";
          document.getElementById("confirmButton").style.backgroundColor = "red";
          document.getElementById("cancelPopup").style.display = "block";
        }

        // Function to open popup for SPECIFIC ITEM CANCELLATION
        function openCancelItem(itemId, itemName) {
          actionType = "cancel";
          targetType = "item";
          currentId = itemId;
          document.getElementById("cancelTitle").innerText = "Cancel: " + itemName;
          document.getElementById("cancelDesc").innerText = "Please enter your cancellation reason:";
          document.getElementById("confirmButton").innerText = "Confirm Cancel";
          document.getElementById("confirmButton").style.backgroundColor = "red";
          document.getElementById("cancelPopup").style.display = "block";
        }

        // Function to open popup for ENTIRE ORDER RETURN
        function openReturnOrder() {
          actionType = "return";
          targetType = "order";
          currentId = "<%= order._id %>";
          document.getElementById("cancelTitle").innerText = "Return Entire Order";
          document.getElementById("cancelDesc").innerText = "Please enter your return reason:";
          document.getElementById("confirmButton").innerText = "Confirm Return";
          document.getElementById("confirmButton").style.backgroundColor = "#7c3aed";
          document.getElementById("cancelPopup").style.display = "block";
        }

        // Function to open popup for SPECIFIC ITEM RETURN
        function openReturnItem(itemId, itemName) {
          actionType = "return";
          targetType = "item";
          currentId = itemId;
          document.getElementById("cancelTitle").innerText = "Return: " + itemName;
          document.getElementById("cancelDesc").innerText = "Please enter your return reason:";
          document.getElementById("confirmButton").innerText = "Confirm Return";
          document.getElementById("confirmButton").style.backgroundColor = "#7c3aed";
          document.getElementById("cancelPopup").style.display = "block";
        }

        // Function to close the popup
        function closeCancelBox() {
          document.getElementById("cancelPopup").style.display = "none";
          document.getElementById("cancelReasonText").value = ""; // Clear text
        }

        // Function to handle the actual logic
        async function confirmAction() {
          const reason = document.getElementById("cancelReasonText").value;

          if (reason.trim() === "") {
            alert("Please provide a reason!");
            return;
          }

          let url = "";
          let method = "PATCH";
          let body = {};

          if (targetType === "order") {
            url = actionType === "cancel" ? '/user/orders' : '/user/orders/return';
            body = {
              orderId: currentId,
              reason: reason
            };
          } else {
            url = actionType === "cancel" ?
              `/user/orders/<%= order._id %>/items/${currentId}` :
              `/user/orders/<%= order._id %>/items/${currentId}/return`;
            body = {
              reason: reason
            };
          }

          try {
            const response = await fetch(url, {
              method: method,
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });

            if (response.ok) {
              alert(`${targetType === 'order' ? 'Order' : 'Item'} ${actionType === 'cancel' ? 'cancelled' : 'returned'} successfully!`);
              location.reload();
            } else {
              const data = await response.json();
              alert("Error: " + (data.message || `Failed to ${actionType} ${targetType}`));
            }
          } catch (error) {
            console.error("Error:", error);
            alert(`Something went wrong while ${actionType === 'cancel' ? 'cancelling' : 'returning'} the ${targetType}.`);
          }
        }

        function downloadInvoice(orderId) {

          console.log(orderId)
          window.location.href = `/order/invoice/${orderId}`;
        }
      </script>
</body>

</html>